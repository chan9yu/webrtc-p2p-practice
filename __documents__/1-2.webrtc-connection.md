# WebRTC는 어떻게 동작할까?

WebRTC가 실시간으로 데이터를 교환할 수 있는 이유는 `시그널링(Signaling)` 기술을 사용하기 때문이다.
<br />
시그널링은 서로의 네트워크 정보를 공유하고 P2P 연결을 성립하는 과정으로, 이를 통해 WebRTC 통신이 이루어진다.

<br />

## WebRTC 동작 과정

일반적인 WebRTC의 동작 과정은 다음과 같다.

1. **P2P 통신 동의**
   <br />
   브라우저가 P2P 통신을 허용할 것인지 사용자 동의를 받음

1. **서로의 주소 공유**
   <br />
   P2P 연결을 위해 각 브라우저가 자신의 **네트워크 주소(IP, 포트 등) 를 공유**함

1. **방화벽 및 보안 정책 우회**
   <br />
   P2P 연결을 직접 할 수 없는 경우, **방화벽을 우회**하는 과정이 필요함

1. **데이터 교환 시작**
   <br />
   위 과정이 완료되면 두 브라우저는 서로 데이터를 교환할 수 있다.

하지만 2번과 3번 과정은 브라우저나 서버에서 직접 제어하기 어려운 부분이다.
<br />
브라우저는 웹 서버가 아니므로, 직접 외부에서 접근할 수 있는 정보가 부족하다.
<br />

따라서 P2P 연결 전에 반드시 `시그널링 서버`를 통해 초기 연결 과정이 진행된다.

<br />

## 시그널링(Signaling)

- `시그널링`은 각 장치(브라우저)가 서로의 위치를 발견하고, P2P 연결을 협의하는 과정
- 일반적으로 시그널링을 위해 `WebSocket`, `SIP(Session Initiation Protocol)`, `XHR Polling` 등 다양한 방식으로 구현될 수 있음
- **P2P** 연결을 위한 네트워크 탐색 과정에서는 `ICE(Interactive Connectivity Establishment)` 프레임워크를 활용하여 `STUN`과 `TURN` 서버를 사용한다.

📝 Google에서 기본적으로 제공하는 `STUN` 서버를 사용할 수 있다.

```json
{
  "urls": [
    "stun:stun.l.google.com:19302",
    "stun:stun1.l.google.com:19302",
    "stun:stun2.l.google.com:19302",
    "stun:stun3.l.google.com:19302",
    "stun:stun4.l.google.com:19302"
  ]
}
```

<br />

## STUN/TURN

### STUN (Session Traversal Utilities for NAT)

- 내 **공인 IP**와 **포트**를 확인하는 역할
- 브라우저가 `STUN` 서버에 요청을 보내, 자신의 **공인 IP**와 **포트**를 받아옴
- 이 과정을 거쳐 서로 연결할 수 있는 고유한 주소를 생성
- 이후 `ICE` 프레임워크가 최적의 네트워크 경로를 결정하며, 가능한 경우 P2P 연결을 시도하고, 실패하면 `TURN` 서버를 사용하게 된다.

> 예시:
> <br />
> 집을 이사하거나 주소가 바뀌었을 때, 정부기관에 새 주소를 등록하는 것

<br />

### TURN (Traversal Using Relays around NAT)

- **중계 서버** 역할
- **방화벽, 보안 정책 등의 문제**로 직접 P2P 연결이 불가능할 때 사용
- 데이터를 중계하여 통신
- P2P 연결이 불가능한 최후의 수단으로 활용됨

> 예시:
> <br />
> 직접 친구에게 택배를 보낼 수 없을 때, 택배 회사를 통해 전달하는 것

<br />

## WebRTC 통신 흐름 요약

1. **STUN 서버 요청**
   <br />
   각 브라우저가 자신의 공인 IP 및 포트 정보를 확인한다.

1. **P2P 연결 시도**
   <br />
   받은 정보를 이용해 직접 통신한다.

1. **연결 실패 시 TURN 사용**
   <br />
   P2P 연결이 방화벽 정책이나 `NAT(Network Address Translation)` 환경에 의해 차단되면,
   `TURN` 서버를 통해 데이터를 중계한다.
